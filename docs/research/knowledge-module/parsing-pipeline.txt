					PARSING PIPELINE 
					
- ParsingEngine execute all pipeline 
- Sub Step: 
	+ parser
	+ fusion
	+ normalize
	
- Pipeline: 
	PDF FILE
	â†“
	[1] Parser Adapters (dÃ¹ng thÆ° viá»‡n)
	  â†“
	RawParseResult[]
	  â†“
	[2] Fusion Engine (merge + chá»n block)
	  â†“
	CanonicalParsedDocument
	  â†“
	[3] Normalize Layer (chuáº©n hÃ³a, nháº¹)
	  â†“
	NormalizedParsedDocument (Ä‘á»ƒ downstream dÃ¹ng)
---

# 1ï¸âƒ£ High-level Flow (tá»•ng quan)

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ParseInput â”‚
        â”‚ (buffer,mime)
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  Document        â”‚
      â”‚  Classification  â”‚
      â”‚  (Profile)       â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  ParseOrchestratorâ”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ParsePlanBuilder â”‚
      â”‚ (select computes)â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Execute Computes â”‚
      â”‚ (PDF, OCR, etc)  â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Fusion Engine    â”‚
      â”‚ (merge results) â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Normalize Serviceâ”‚
      â”‚ (canonical doc) â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ CanonicalParsed  â”‚
      â”‚ Document         â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# 2ï¸âƒ£ Chi tiáº¿t tá»«ng bÆ°á»›c (mapping vá»›i code)

---

## STEP 1 â€” Input

```ts
ParseInput {
  buffer: Buffer
  mime: string
}
```

â¡ **Chá»‰ lÃ  raw data**, chÆ°a quyáº¿t Ä‘á»‹nh parse kiá»ƒu gÃ¬

---

## STEP 2 â€” Classification â†’ DocumentProcessingProfile

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DocumentClassifier       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - content_category       â”‚
â”‚ - ocr_required           â”‚
â”‚ - layout_complexity      â”‚
â”‚ - language_hint          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
DocumentProcessingProfile
```

VÃ­ dá»¥:

```ts
{
  content_category: "academic",
  ocr_required: "no",
}
```

ğŸ“Œ **Profile = chiáº¿n lÆ°á»£c xá»­ lÃ½**, khÃ´ng parse gÃ¬ á»Ÿ Ä‘Ã¢y

---

## STEP 3 â€” Build ParseContext

```ts
ParseContext {
  input,
  detectedMime,
  confidence,
  profile,         
  signals: {
    scanned?: boolean
  },
  results: Map
}
```

â¡ Context lÃ  **tráº¡ng thÃ¡i sá»‘ng suá»‘t pipeline**

---

## STEP 4 â€” ParseOrchestrator

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ParseOrchestrator          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. init context            â”‚
â”‚ 2. build plan              â”‚
â”‚ 3. execute plan            â”‚
â”‚ 4. fallback (náº¿u cáº§n)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
```

---

## STEP 5 â€” ParsePlanBuilder (trÃ¡i tim)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ParsePlanBuilder             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Input:                       â”‚
â”‚ - ParseContext               â”‚
â”‚ - List<BaseCompute>          â”‚
â”‚                              â”‚
â”‚ Logic:                       â”‚
â”‚ - supports(profile)          â”‚
â”‚ - capability match           â”‚
â”‚ - rank by reliability/cost   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
```

### Output:

```
ParsePlan = [
  PdfTextParser   (primary, low cost),
  PdfLayoutParser (secondary),
  OcrParser       (fallback)
]
```

---

## STEP 6 â€” Execute ParsePlan

```
FOR each ParseStep in order:
    â”œâ”€ compute.parse(input, context)
    â”‚
    â”œâ”€ save raw result to context.results
    â”‚
    â”œâ”€ evaluate fallback policy
    â”‚
    â””â”€ stop or continue
```

ASCII flow:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PdfTextParser â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ success?
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ stop or next  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                            â”‚ fallback
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
       â”‚ OCR Parser    â”‚â”€â”€â”€â”€â”˜
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## STEP 7 â€” RawParseResult

Má»—i compute tráº£ vá»:

```ts
RawParseResult {
  engine: "pdf-text",
  blocks: RawBlock[],
  confidence?: number
}
```

â¡ **KHÃ”NG semantic**
â¡ **KHÃ”NG normalize**
â¡ **KHÃ”NG merge**

---

## STEP 8 â€” Fusion Engine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FusionEngine             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - merge blocks           â”‚
â”‚ - resolve overlaps       â”‚
â”‚ - confidence weighting   â”‚
â”‚ - provenance tracking    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
```

Output:

```ts
CanonicalParsedDocument
```

---

## STEP 9 â€” Normalize Service

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NormalizeService         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - unify block schema     â”‚
â”‚ - fix coordinates       â”‚
â”‚ - clean metadata        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
```

â¡ Final output cho downstream (LLM, search, QA)

---

# 3ï¸âƒ£ ToÃ n bá»™ pipeline gá»™p láº¡i (ASCII)

```
ParseInput
   â”‚
   â–¼
Classifier â”€â”€â–¶ DocumentProcessingProfile
   â”‚
   â–¼
ParseContext
   â”‚
   â–¼
ParseOrchestrator
   â”‚
   â–¼
ParsePlanBuilder
   â”‚
   â–¼
[ Compute 1 ] â”€â–¶ RawResult
   â”‚
   â”œâ”€ fallback?
   â”‚
   â–¼
[ Compute 2 ] â”€â–¶ RawResult
   â”‚
   â–¼
FusionEngine
   â”‚
   â–¼
NormalizeService
   â”‚
   â–¼
CanonicalParsedDocument
```

---

# 4ï¸âƒ£ Insight quan trá»ng

* **Parser / Compute = dumb worker**
* **Profile = strategy**
* **Context = state**
* **PlanBuilder = brain**
* **Fusion â‰  Parse**
* **Normalize â‰  Semantic**


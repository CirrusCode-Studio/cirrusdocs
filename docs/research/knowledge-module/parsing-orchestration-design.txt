				Parsing Orchestration Design
				
1. Parse Orchestration lÃ  gÃ¬ & khÃ´ng lÃ  gÃ¬
2.Input / Output contract
3. Core responsibilities
4. Kiáº¿n trÃºc thÆ° má»¥c Ä‘á» xuáº¥t
5. CÃ¡ch dÃ¹ng DocumentProcessingProfile
6. Luá»“ng thá»±c thi chi tiáº¿t
7. Mapping classification â†’ parser
8. VÃ¬ sao thiáº¿t káº¿ nÃ y cover gáº§n nhÆ° má»i behavior dá»¯ liá»‡u

	1. Parse Orchestration lÃ  gÃ¬?
Parse Orchestration = bá»™ nÃ£o Ä‘iá»u phá»‘i parsing
- NÃ³:
	KHÃ”NG parse
	KHÃ”NG Ä‘oÃ¡n
	KHÃ”NG Ä‘á»c raw content
- NÃ³ chá»‰:
	+ Ä‘á»c DocumentProcessingProfile
	+ quyáº¿t Ä‘á»‹nh:
		dÃ¹ng parser nÃ o
		thá»© tá»±
		fallback
		quality gate
		retry strategy
ğŸ“Œ NÃ³ lÃ  strategy executor

	2. Input / Output
	Input
	interface ParseOrchestrationInput {
	  docId: string;
	  file: StoredDocumentRef;
	  profile: DocumentProcessingProfile;
	}

	Output
	interface ParseOrchestrationResult {
	  rawBlocks: RawBlock[];
	  metadata: {
	    profile: DocumentProcessingProfile;
	    usedParsers: string[];
	    fallbackTriggered: boolean;
	    qualityWarnings: string[];
	  };
	}

	3. Core responsibilities (Ráº¤T QUAN TRá»ŒNG)
Parse Orchestrator chá»‹u trÃ¡ch nhiá»‡m:
	TrÃ¡ch nhiá»‡m	CÃ³
	Chá»n parser	âœ…
	Quyáº¿t Ä‘á»‹nh OCR	âœ…
	Cháº¡y nhiá»u parser	âœ…
	Fallback	âœ…
	Retry	âœ…
	Quality gate	âœ…
	Explainability	âœ…
Parse block	âŒ

	4. ThÆ° má»¥c Ä‘á» xuáº¥t
parsing/
â”œâ”€â”€ orchestration
â”‚   â”œâ”€â”€ parse-orchestrator.ts
â”‚   â”œâ”€â”€ parse-plan.builder.ts
â”‚   â”œâ”€â”€ parse-plan.contract.ts
â”‚   â”œâ”€â”€ parse-context.ts
â”‚   â”œâ”€â”€ parser-selector.ts
â”‚   â””â”€â”€ fallback-policy.ts
â”œâ”€â”€ engine
â”‚   â””â”€â”€ parse-engine.ts
â”œâ”€â”€ profiles
â”‚   â”œâ”€â”€ academic.profile.ts
â”‚   â”œâ”€â”€ slide.profile.ts
â”‚   â”œâ”€â”€ scanned.profile.ts
â”‚   â””â”€â”€ generic.profile.ts
â””â”€â”€ parsers
    â””â”€â”€ ...

	5. ParsePlan â€“ thá»© orchestration thá»±c sá»± táº¡o ra

export interface ParsePlan {
  profileName: string;

  steps: Array<{
    parser: BaseParser;
    inputType: 'file' | 'blocks';
    enabled: boolean;
  }>;

  qualityGates: QualityGate[];
  fallback?: ParsePlan;
}


ğŸ“Œ Orchestrator build ParsePlan, engine chá»‰ cháº¡y plan

	6. Parse Orchestrator (trung tÃ¢m)
export class ParseOrchestrator {
  constructor(
    private readonly selector: ParserSelector,
    private readonly engine: ParseEngine,
    private readonly fallbackPolicy: FallbackPolicy
  ) {}

  async orchestrate(input: ParseOrchestrationInput) {
    const plan = this.selector.buildPlan(input.profile);

    let result = await this.engine.execute(plan, input.file);

    if (!this.engine.passesQuality(plan, result)) {
      const fallback = this.fallbackPolicy.resolve(plan);
      result = await this.engine.execute(fallback, input.file);
    }

    return result;
  }
}

	7. ParserSelector â€“ mapping classification â†’ parsing
export class ParserSelector {
  buildPlan(profile: DocumentProcessingProfile): ParsePlan {
    switch (profile.content_category) {
      case 'academic':
        return AcademicParseProfile(profile);
      case 'slide':
        return SlideParseProfile(profile);
      case 'scanned':
        return ScannedParseProfile(profile);
      default:
        return GenericParseProfile(profile);
    }
  }
}


ğŸ“Œ KhÃ´ng logic parse á»Ÿ Ä‘Ã¢y
ğŸ“Œ Chá»‰ composition

	8.ParseProfile (academic)
export function AcademicParseProfile(
  profile: DocumentProcessingProfile
): ParsePlan {
  return {
    profileName: 'ACADEMIC_PARSE',
    steps: [
      { parser: new PdfTextParser(), inputType: 'file', enabled: true },
      { parser: new TableParser(), inputType: 'blocks', enabled: true },
      { parser: new FormulaParser(), inputType: 'blocks', enabled: true },
    ],
    qualityGates: [
      new MissingTableGate(),
      new TooManyUnknownGate(),
    ],
    fallback: GenericParseProfile(profile),
  };
}

	9. Slide ParseProfile
export function SlideParseProfile(profile): ParsePlan {
  return {
    profileName: 'SLIDE_PARSE',
    steps: [
      { parser: new PdfTextParser({ preferLayout: true }), enabled: true },
      { parser: new FigureParser(), enabled: true },
    ],
    qualityGates: [],
  };
}

	10. Scanned ParseProfile
export function ScannedParseProfile(profile): ParsePlan {
  return {
    profileName: 'SCANNED_PARSE',
    steps: [
      { parser: new OcrParser(), enabled: true },
      { parser: new TableParser(), enabled: profile.processing_intent.preserve_tables },
    ],
    qualityGates: [],
  };
}

	11. ParseEngine (thá»±c thi plan, KHÃ”NG suy nghÄ©)
export class ParseEngine {
  async execute(plan: ParsePlan, file): Promise<RawBlock[]> {
    let blocks = [];

    for (const step of plan.steps) {
      if (!step.enabled) continue;
      blocks = await step.parser.parse(file, blocks);
    }

    return blocks;
  }
}

	12. VÃ¬ sao kiáº¿n trÃºc nÃ y cover gáº§n nhÆ° toÃ n bá»™ behavior user?
VÃ¬:
	Classification quyáº¿t Ä‘á»‹nh intent
	ParsePlan tÃ¡ch khá»i code
	Parser Ä‘á»™c láº­p
	Fallback lÃ  first-class
	Quality gate báº£o vá»‡
	Override Ä‘Æ°á»£c
